{% extends 'OpensoftCodeConversationBundle::layout.html.twig' %}

{% block page_title %}Show commit {{ commit.sha1|truncate(6) }}{% endblock %}

{% block content %}

    {% include 'OpensoftCodeConversationBundle::commit.html.twig' with {'commit': commit, 'project': project} %}

    <h3>{{ commit.message }}</h3>

    <dl>
        <dt>Sha1 Hash</dt>
        <dd>{{ commit.sha1 }}</dd>

        <dt>Author</dt>
        <dd>{{ commit.author }}</dd>

        <dt>Commited</dt>
        <dd>{{ commit.timestamp|date("F j, Y G:i:s") }}</dd>

        <dt>Parent</dt>
        <dd><a href="{{ path('opensoft_codeconversation_default_showcommit', {'projectId': project.id, 'commitHash': commit.parent }) }}">{{ commit.parent }}</a></dd>

        {% if commit.mergeParent %}
            <dt>Merge Parent</dt>
            <dd><a href="{{ path('opensoft_codeconversation_default_showcommit', {'projectId': project.id, 'commitHash': commit.mergeParent }) }}">{{ commit.mergeParent }}</a></dd>
        {% endif %}
    </dl>

    {% if commit.fileDiffs %}
        <h3>Diffs</h3>

        <div>

        {% for diff in commit.fileDiffs %}


            <table cellpadding="0" cellspacing="0">
                <thead>
                    <th colspan="3">
                        <span class="label">{{ diff.status }}</span>

                        {% if diff.status == constant("Opensoft\\Bundle\\CodeConversationBundle\\Model\\Diff::STATUS_MODIFICATION") %}
                            {{ diff.dstPath }}
                        {% elseif diff.status == constant("Opensoft\\Bundle\\CodeConversationBundle\\Model\\Diff::STATUS_ADDITION") %}
                            {{ diff.dstPath }}
                        {% elseif diff.status == constant("Opensoft\\Bundle\\CodeConversationBundle\\Model\\Diff::STATUS_DELETION") %}
                            {{ diff.srcPath }}
                        {% endif %}
                    </th>
                </thead>
                <tbody style="overflow: scroll;">

                    {% for diffChunk in diff.diffChunks %}
                        {% set srcLineCount = diffChunk.srcStartLineNumber %}
                        {% set dstLineCount = diffChunk.dstStartLineNumber %}

                        <tr>
                            <td style="color: #AAA; padding: 0px 3px; border: none; border-right: 1px solid #DDD; text-align: center; background-color: #f5f5f5;">
                                ...
                            </td>
                            <td style="color: #AAA; padding: 0px 3px; border: none; border-right: 1px solid #DDD; text-align: center; background-color: #f5f5f5;">
                                ...
                            </td>
                            <td style="padding: 0px; border: none;" width="100%">
                                 <pre style="color: #AAA; padding: 0px; margin: 0px; border: none; background-color: #f5f5f5; border-radius: 0px;">{{ diffChunk.description }}</pre>
                            </td>
                        </tr>


                        {% for line in diffChunk.content %}

                            {% set srcAddition = "%.1s"|format(line) == '+' %}
                            {% set srcDeletion = "%.1s"|format(line) == '-' %}

                            <tr>
                                <td style="color: #AAA; padding: 0px 3px; border: none; border-right: 1px solid #DDD; text-align: center; background-color: #f5f5f5;">
                                    {% if srcDeletion or (not srcAddition and not srcDeletion) %}
                                        {{ srcLineCount != 0 ? srcLineCount : " "}}
                                        {% set srcLineCount = srcLineCount + 1 %}
                                    {% endif %}
                                </td>
                                <td style="color: #AAA; padding: 0px 3px; border: none; border-right: 1px solid #DDD; text-align: center; background-color: #f5f5f5;">
                                    {% if srcAddition or (not srcAddition and not srcDeletion) %}
                                        {{ dstLineCount != 0 ? dstLineCount : " "}}
                                        {% set dstLineCount = dstLineCount + 1 %}
                                    {% endif %}
                                </td>
                                <td style="padding: 0px; border: none;">
                                    {% if srcAddition %}
                                        <pre style="padding: 0px; margin: 0px; border: none; background-color: #DFD; border-radius: 0px;">{{ line }}</pre>
                                    {% elseif srcDeletion %}
                                        <pre style="padding: 0px; margin: 0px; border: none; background-color: #FDD; border-radius: 0px;">{{ line }}</pre>
                                    {% else %}
                                        <pre style="padding: 0px; margin: 0px; border: none; background-color: #f5f5f5; border-radius: 0px;">{{ line }}</pre>
                                    {% endif %}
                                </td>
                            </tr>

                        {% endfor %}

                    {% endfor %}
                </tbody>
            </table>

        {% endfor %}

        </div>
    {% endif %}
{% endblock %}